#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-

require 'rubygems'
require 'dzen'
require 'notifier'
require '../lib/comrade/optparse'
require '../lib/comrade/timer'

@options_hash = Comrade::Optparse.parse! ARGV
@timer = Comrade::Timer.new @options_hash[:timer] if @options_hash[:timer]

configure do |c|
  c.interval = 2
  c.output = IO.popen(
               'dzen2' <<
                 " -h #{@options_hash[:thickness]}" <<
                 ' -ta l' << 
                 ' -bg black' <<
                 " -w #{@options_hash[:size]}" <<
                 ' -e "onstart=ungrabkeys,ungrabmouse"',
               'w'
              )
end

before_run do
  puts 'Started @ ' << DateTime.now.to_s
end

app :line do
  if @timer.finished? and @timer.loop?
    puts 'Another loop @ ' << DateTime.now.to_s
    @timer = Comrade::Timer.new @options_hash[:timer]
  elsif @timer.finished?
    puts 'Stopped @ ' << DateTime.now.to_s
    Notifier.notify :title => 'comrade', :message => ARGV.join(' ')
    Process.kill('INT', $$)
  end

  line_size = (@timer.remaining_ratio * @options_hash[:size].to_f).round
  "^fg(#{@options_hash[:color]})^r(#{line_size}x#{@options_hash[:thickness]})"
end
