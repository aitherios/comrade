#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-

require 'rubygems'
require 'dzen'
require 'notifier'
require 'comrade/timer'
require 'comrade/optparse'

@options_hash = Comrade::Optparse.parse! ARGV
@timer = Comrade::Timer.new @options_hash[:timer] if @options_hash[:timer]

puts @options_hash[:message]
exit if @options_hash[:exit]

configure do |c|
  c.interval = 2
  c.output = IO.popen(
               'dzen2' <<
                 " -h #{@options_hash[:thickness]}" <<
                 " -w #{@options_hash[:size]}" <<
                 " -x #{@options_hash[:xposition]}" <<
                 " -y #{@options_hash[:yposition]}" <<
                 ' -ta l' << 
                 " -bg #{@options_hash[:background_color]}" <<
                 " -fg #{@options_hash[:color]}" <<
                 ' -e "onstart=ungrabkeys,ungrabmouse"',
               'w'
              )
end

before_run do
  puts 'Started @ ' << DateTime.now.to_s
end

app :line do
  if @timer.finished? and @timer.loop?
    puts 'Another loop @ ' << DateTime.now.to_s
    @timer = Comrade::Timer.new @options_hash[:timer]
  elsif @timer.finished?
    puts 'Stopped @ ' << DateTime.now.to_s
    Notifier.notify :title => 'comrade', :message => ARGV.join(' ')
    Process.kill('INT', $$)
  end

  line_size = (@timer.remaining_ratio * @options_hash[:size].to_f).round
  "^r(#{line_size}x#{@options_hash[:thickness]})"
end
